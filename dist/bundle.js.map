{"version":3,"file":"bundle.js","sources":["../src/lib/kill_proc.js","../src/lib/cleanup.js","../src/lib/get_options.js","../src/index.js"],"sourcesContent":["import cp from 'child_process';\n//http://krasimirtsonev.com/blog/article/Nodejs-managing-child-processes-starting-stopping-exec-spawn\nexport default function killProc(proc, signal){\n    let pid = proc.pid;\n    signal = signal || 'SIGKILL';\n\n    const getKill = reject=>{\n        if(!/^win/.test(process.platform)){\n            return tpid => {\n                try{ process.kill(tpid, signal); }\n                catch(e){}\n            };\n        }\n\n        return tpid => {\n            cp.exec('taskkill /PID ' + tpid + ' /T /F', reject);\n        };\n    };\n\n    return new Promise((resolve, reject)=>{\n        psTree(pid, (err, children) => {\n            if(err) return reject(err);\n\n            [pid].concat(children.map(p => p.PID))\n            .forEach(getKill(reject));\n            setTimeout(resolve, 1);\n        });\n    });\n}\n","import killProc from './kill_proc.js';\n\nexport default function cleanup(\n    {queue = []} = {}\n){\n    function ifEnd(event){\n        process.on(event, () => {\n            queue.forEach(item=>{\n                //Make sure all children are killed.\n                killProc(item.child, event);\n                //How child processes could be killed\n                //item.child.kill(event);\n            });\n            scripts = [];\n        });\n    }\n\n    ['SIGINT', 'SIGTERM'].forEach(ifEnd);\n}\n","export default function getOptions(opts){\n\n    return Object.assign(\n        opts,\n        {\n            //Preserve I/O options for merging.\n            stdio: [\n                null,\n                null,\n                null\n            ]\n        }\n    );\n}\n","import { spawn } from 'child_process';\nimport tapMerge from 'tap-merge';\nimport through from 'through2';\nimport killProc from './lib/kill_proc.js';\nimport cleanup from './lib/cleanup.js';\nimport getOptions from './lib/get_options.js';\nimport os from 'os';\nconst cpuMax = os.cpus().length;\n\n\nexport default function rtp(scripts, {\n    argv = [],\n    tap = false,\n    commandOpts = {},\n    onError = null,\n    failFast = true\n} = {}){\n\n    let startCount = scripts.length < cpuMax\n    ? scripts.length : cpuMax;\n    let options = getOptions(commandOpts);\n    let queue = [];\n    let stdout = through(), stderr = through();\n    let childError = false;\n\n    let io = {\n        stdout, stderr,\n        print(){\n            this.stdout.pipe(process.stdout);\n            this.stderr.pipe(process.stderr);\n        }\n    };\n\n    if(tap){\n        let tm = tapMerge();\n        tm.pipe(stdout);\n        //Change the internal writable\n        stdout = tm;\n    }\n\n    cleanup({queue});\n\n    function run(){\n\n        if(\n            !scripts.length //Sanity check.\n            || childError\n            || queue.length === cpuMax\n        ) return;\n\n        let script = scripts.shift();\n        let index = queue.length;\n\n        let c = spawn('node', [script].concat(argv), options);\n\n        queue.push({\n            complete: false,\n            stdout: [],\n            stderr: [],\n            child: c,\n            set index(v){\n                index = v;\n            }\n        });\n\n        if(scripts.length){\n            //Some scripts remain\n            c.on('exit', code=>{\n                run();\n            });\n        }\n\n        c.stdout.on('data', data=>{\n            queue[index].stdout.push(data);\n        });\n\n        c.stdout.on('finish', a=>{\n            queue[index].complete = true;\n\n            while(queue.length){\n                //Write as many as possible\n                if(queue[0].complete){\n                    let output = queue.shift();\n                    for(let i=0; i<output.stdout.length; i++){\n                        stdout.write(output.stdout[i]);\n                    }\n\n                    output = null;\n\n                    if(!scripts.length && !queue.length){\n                        stdout.end();\n                    }\n\n                    queue.forEach((item, i)=>{\n                        item.index = i;\n                    });\n\n                }else{\n                    //Some output might be available so\n                    while(queue[0].stdout.length){\n                        stdout.write(queue[0].stdout.shift());\n                    }\n                    break;\n                }\n            }\n        });\n\n        c.stderr.on('data', data=>{\n            queue[index].stderr.push(data);\n        });\n\n        c.stderr.on('finish', a=>{\n            if(queue[index] && queue[index].stderr.length){\n\n                queue[index].complete = true;\n                childError = true;\n\n                let error = new Error(\n                    'child process error (PID # '+c.pid+'): \\n'+\n                    output\n                );\n\n                if(typeof onError === 'function'){\n                    return onError(error);\n                }\n\n                if(failFast){\n                    let output = queue[index].stderr.join('');\n                    scripts = [];\n                    //Throw an error instead of calling process.exit()\n                    //This allows the event queue of the main process to run out\n                    throw error;\n                }else{\n                    error = null;\n                    let output = queue.splice(index, 1);\n                    while(output.stderr.length){\n                        stderr.write(output.stderr.shift());\n                    }\n                    queue.forEach((item, i)=>{\n                        item.index = i;\n                    });\n                }\n            }\n        });\n    }\n\n    for(let i=0; i<startCount; i++){\n        run();\n    }\n\n    return io;\n};\n"],"names":["cp","spawn"],"mappings":"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"}